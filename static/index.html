<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>CMD SaaS Auth Helper</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
    <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>
    <main class="container">
        <h1>üîê CMD SaaS Auth Helper</h1>

        <article id="success-alert" hidden>‚úÖ Successfully authenticated!</article>

        <label>
            API Gateway URL:
            <input type="text" id="api-url" placeholder="https://api.acme-corp.dev-gummi.saas.cmddev.thermofisher.com">
            <small id="preset-container">
                Recent URLs: <span id="preset-list"></span>
            </small>
        </label>

        <div role="group">
            <button onclick="login()">Login</button>
            <button onclick="logout()" class="secondary">Logout</button>
            <button onclick="resetUrl()" class="secondary outline">Reset URL</button>
        </div>

        <article id="session-box" hidden>
            <strong>Session ID:</strong>
            <pre><code id="session-id"></code></pre>
            <button onclick="copySession()">Copy to Clipboard</button>

            <details>
                <summary>Usage with curl</summary>
                <pre><code id="curl-example">curl -H "Cookie: session_id=YOUR_SESSION_ID" \
  -H "Origin: http://localhost:3000" \
  https://api.acme-corp.dev-gummi.saas.cmddev.thermofisher.com/api/v1/drive/internal/folders</code></pre>
            </details>
        </article>
    </main>

    <script>
        const MAX_PRESETS = 5;

        // Fetch default URL from server, use if no saved URL
        fetch('/config')
            .then(r => r.json())
            .then(config => {
                if (!localStorage.getItem('api_url')) {
                    document.getElementById('api-url').value = config.default_api_url;
                }
            });

        // Restore API URL from localStorage on page load
        const savedApiUrl = localStorage.getItem('api_url');
        if (savedApiUrl) {
            document.getElementById('api-url').value = savedApiUrl;
        }

        // Render presets on page load
        renderPresets();

        // Check for success parameter on page load
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('success') === 'true') {
            document.getElementById('success-alert').hidden = false;
            loadSession();
            // Clean up URL without page reload
            window.history.replaceState({}, '', '/');
        }

        // Load session on initial page load
        loadSession();

        function getPresets() {
            const presets = localStorage.getItem('api_url_presets');
            return presets ? JSON.parse(presets) : [];
        }

        function savePresets(presets) {
            localStorage.setItem('api_url_presets', JSON.stringify(presets));
        }

        function addPreset(apiUrl) {
            if (!apiUrl) return;

            let presets = getPresets();

            // Check if URL already exists
            if (presets.includes(apiUrl)) {
                return; // Already in list
            }

            // Add new URL
            presets.push(apiUrl);

            // Keep only last MAX_PRESETS (FIFO: remove oldest)
            if (presets.length > MAX_PRESETS) {
                presets.shift(); // Remove first (oldest) element
            }

            savePresets(presets);
            renderPresets();
        }

        function parseUrlDisplay(url) {
            // Extract tenant and environment from URL
            // Format: https://api.{tenant}.{env}.saas.cmddev.thermofisher.com
            try {
                const match = url.match(/https:\/\/api\.([^.]+)\.([^.]+)\.saas\.cmddev\.thermofisher\.com/);
                if (match) {
                    return `${match[1]} (${match[2]})`;
                }
            } catch (e) {
                console.error('Failed to parse URL:', e);
            }
            // Fallback to showing raw URL if parsing fails
            return url;
        }

        function renderPresets() {
            const presets = getPresets();
            const presetList = document.getElementById('preset-list');
            const presetContainer = document.getElementById('preset-container');

            if (presets.length === 0) {
                presetContainer.hidden = true;
                return;
            }

            presetContainer.hidden = false;
            presetList.innerHTML = presets.map((url, index) => {
                const display = parseUrlDisplay(url);
                return `<a href="#" onclick="selectPreset('${url}'); return false;">${display}</a>`;
            }).join(' | ');
        }

        function selectPreset(apiUrl) {
            document.getElementById('api-url').value = apiUrl;
            localStorage.setItem('api_url', apiUrl);
        }

        function resetUrl() {
            localStorage.removeItem('api_url');
            localStorage.removeItem('api_url_presets');
            fetch('/config')
                .then(r => r.json())
                .then(config => {
                    document.getElementById('api-url').value = config.default_api_url;
                    renderPresets();
                });
        }

        function login() {
            const apiUrl = document.getElementById('api-url').value;
            if (!apiUrl) {
                alert('Please enter an API Gateway URL');
                return;
            }
            // Save to localStorage before redirecting
            localStorage.setItem('api_url', apiUrl);
            window.location.href = `/login?api_url=${encodeURIComponent(apiUrl)}`;
        }

        function logout() {
            if (confirm('Clear current session?')) {
                fetch('/logout', { method: 'POST' })
                    .then(() => {
                        document.getElementById('session-box').hidden = true;
                        document.getElementById('session-id').textContent = '';
                        document.getElementById('success-alert').hidden = true;
                    })
                    .catch(err => console.error('Logout failed:', err));
            }
        }

        function loadSession() {
            fetch('/session')
                .then(r => r.json())
                .then(data => {
                    if (data.session_id) {
                        document.getElementById('session-id').textContent = data.session_id;
                        document.getElementById('session-box').hidden = false;
                        updateCurlExample(data.session_id);

                        // Add current API URL to presets after successful login
                        const currentApiUrl = document.getElementById('api-url').value;
                        if (currentApiUrl) {
                            addPreset(currentApiUrl);
                        }
                    }
                })
                .catch(err => console.error('Failed to load session:', err));
        }

        function copySession() {
            const sessionId = document.getElementById('session-id').textContent;
            navigator.clipboard.writeText(sessionId)
                .then(() => alert('Session ID copied to clipboard!'))
                .catch(err => {
                    console.error('Copy failed:', err);
                    alert('Failed to copy. Please select and copy manually.');
                });
        }

        function updateCurlExample(sessionId) {
            const apiUrl = document.getElementById('api-url').value ||
                'https://api.acme-corp.dev-gummi.saas.cmddev.thermofisher.com';
            const example = `curl -H "Cookie: session_id=${sessionId}" \\
  -H "Origin: http://localhost:3000" \\
  ${apiUrl}/api/v1/drive/internal/folders`;
            document.getElementById('curl-example').textContent = example;
        }
    </script>
</body>
</html>
